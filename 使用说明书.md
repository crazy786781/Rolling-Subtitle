# 地震预警及情报实况栏 - 使用说明书

## 软件简介

地震预警及情报实况栏是一款实时地震信息显示程序，通过WebSocket连接多个数据源，以滚动字幕形式实时展示地震预警、速报和气象预警信息。程序支持多数据源聚合、自动重连、震级过滤等功能，界面可自定义字体、颜色、透明度等参数，适合用于地震信息监控和展示。

## 目录

1. [项目简介](#项目简介)
2. [功能特性](#功能特性)
3. [系统要求](#系统要求)
4. [安装与运行](#安装与运行)
5. [使用说明](#使用说明)
6. [配置说明](#配置说明)
7. [数据源说明](#数据源说明)
8. [常见问题](#常见问题)
9. [技术架构](#技术架构)
10. [更新日志](#更新日志)

---

## 项目简介

地震预警及情报实况栏是一款基于Python开发的实时地震信息显示程序，通过WebSocket连接多个数据源，实时接收并滚动显示地震预警、速报和气象预警信息。程序采用PyQt5框架构建，具有流畅的滚动动画效果和丰富的自定义选项。

### 主要用途

- 实时显示地震预警信息
- 展示地震速报数据
- 显示气象预警信号
- 支持多数据源聚合显示
- 可自定义界面样式和显示参数

---

## 功能特性

### 核心功能

- **📺 滚动字幕显示**：流畅的横向滚动动画，支持自定义滚动速度
- **🔌 多数据源支持**：同时连接多个WebSocket数据源，自动聚合显示
- **🎨 界面自定义**：支持自定义字体大小、颜色、透明度、窗口尺寸等
- **⚙️ 灵活配置**：提供图形化设置界面，所有参数可实时调整
- **📝 完整日志**：详细的运行日志记录，便于问题排查
- **🔄 自动重连**：数据源断线后自动重连，保证信息接收的连续性
- **🎯 智能过滤**：支持按震级过滤消息，只显示重要信息
- **🌍 地名修正**：自动修正国外地震地名，提供更准确的中文地名

### 消息类型支持

1. **地震预警**：来自中国地震预警网、日本气象厅、韩国气象厅等
2. **地震速报**：来自中国地震台网、美国地质调查局、欧洲地中海地震中心等
3. **气象预警**：来自气象部门的各类预警信号

---

## 系统要求

### 操作系统

- Windows 7 及以上版本（推荐 Windows 10/11）
- 支持 32 位和 64 位系统

### Python 环境（源码运行）

- Python 3.7 及以上版本
- 推荐使用 Python 3.9 或更高版本

### 硬件要求

- 内存：至少 512MB 可用内存
- 网络：需要稳定的互联网连接（用于连接WebSocket数据源）
- 显示：支持 800x100 及以上分辨率

### 运行库（使用打包 exe 时）

- 建议安装 **Visual C++ Redistributable**（如 2015–2022 x64），可从微软官网下载。若打包后 exe 无法启动，可先安装运行库后重试。

---

## 安装与运行

### 方式一：使用打包后的可执行文件（推荐）

1. 下载 `地震预警及情报实况栏.exe` 文件
2. 双击运行即可，无需安装 Python 环境
3. 首次运行会自动创建配置文件
4. 若提供有「调试版」exe（带控制台），可在正式版无法打开时改用调试版，从命令行运行以查看报错信息

### 方式二：从源码运行

#### 1. 安装依赖

```bash
pip install -r requirements.txt
```

或手动安装：

```bash
pip install websockets requests Pillow PyQt5
```

#### 2. 运行程序

```bash
python main.py
```

或使用批处理文件：

```bash
run.bat
```

---

## 使用说明

### 启动程序

1. 运行程序后，会自动连接到配置的数据源
2. 窗口会显示滚动字幕，实时展示地震信息
3. 程序首次运行会在以下位置创建配置文件：
   ```
   C:\Users\你的用户名\AppData\Roaming\subtitl\settings.json
   ```

### 主界面操作

#### 右键菜单

在主窗口上右键点击，可以打开设置菜单：

- **设置**：打开设置窗口
- **退出**：关闭程序

#### 窗口控制

- **拖拽**：可以拖动窗口到任意位置
- **调整大小**：如果启用了窗口可调整大小，可以拖拽窗口边缘调整尺寸
- **置顶显示**：窗口默认置顶显示，确保信息始终可见

### 设置窗口

点击右键菜单中的"设置"，打开设置窗口。设置窗口包含以下标签页：

#### 1. 显示设置

- **字体大小**：调整滚动文字的字体大小（10-100）
- **滚动速度**：调整文字滚动速度（0.1-20.0）
- **背景颜色**：选择窗口背景颜色
- **预警颜色**：地震预警信息的显示颜色（默认红色）
- **速报颜色**：地震速报信息的显示颜色（默认青色）
- **默认颜色**：其他信息的显示颜色（默认绿色）
- **气象预警颜色**：气象预警信息的显示颜色（默认黄色）
- **窗口透明度**：调整窗口透明度（0.1-1.0）
- **窗口宽度**：设置窗口宽度（800-3000像素）
- **窗口高度**：设置窗口高度（100-500像素）
- **可调整大小**：是否允许手动调整窗口大小
- **垂直同步**：启用/禁用垂直同步（影响性能）
- **目标帧率**：设置目标帧率（1-240 FPS）

#### 2. 消息设置

- **消息最大长度**：限制单条消息的最大显示长度（0表示不限制）
- **显示持续时间**：每条消息显示的持续时间（秒，0表示自动）
- **预警无活动时长**：预警消息无活动后显示提示信息的时间（秒）
- **速报无活动时长**：速报消息无活动后显示提示信息的时间（秒）
- **其他消息无活动时长**：其他消息无活动后显示提示信息的时间（秒）
- **无活动提示信息**：当无新消息时显示的自定义文本
- **自定义文本**：可以设置自定义滚动文本

#### 3. 数据源设置

- **启用/禁用数据源**：可以勾选或取消勾选各个数据源
- **数据源列表**：显示所有可用的数据源及其状态

支持的数据源包括：

- **Fan Studio** (`wss://ws.fanstudio.tech/all`)：聚合多个数据源
  - 中国地震台网中心（CENC）
  - 中国地震预警网（CEA）
  - 台湾中央气象署（CWA）
  - 日本气象厅（JMA）
  - 美国地质调查局（USGS）
  - 欧洲地中海地震中心（EMSC）
  - 韩国气象厅（KMA）
  - 以及其他多个国际数据源

#### 4. 震级过滤

- **启用震级过滤**：开启后只显示达到指定震级的地震信息
- **预警最小震级**：地震预警的最小显示震级
- **速报最小震级**：地震速报的最小显示震级
- **其他消息最小震级**：其他类型消息的最小显示震级

#### 5. 关于

- 显示程序版本信息
- 显示数据源连接状态
- 显示气象预警图片（如果收到气象预警消息）

---

## 配置说明

### 配置文件位置

配置文件保存在：
```
C:\Users\你的用户名\AppData\Roaming\subtitl\settings.json
```

### 配置文件结构

配置文件采用JSON格式，包含以下主要部分：

```json
{
  "gui_config": {
    "font_size": 40,
    "text_speed": 4.0,
    "bg_color": "black",
    "warning_color": "#FF0004",
    "info_color": "#01FF00",
    "opacity": 1.0,
    "window_width": 1000,
    "window_height": 100,
    "resizable": true,
    "vsync_enabled": true,
    "target_fps": 60
  },
  "message_config": {
    "max_message_length": 0,
    "display_duration": 0,
    "max_warning_inactivity_time": 600,
    "max_report_inactivity_time": 300,
    "max_other_inactivity_time": 300,
    "no_activity_message": "系统运行中，等待最新地震信息...",
    "custom_text": "系统运行中，等待最新地震信息...",
    "warning_color": "#FF0000",
    "report_color": "#00FFFF",
    "default_color": "#01FF00",
    "weather_warning_color": "#FFF500"
  },
  "ws_config": {
    "reconnect_interval": 5,
    "max_reconnect_attempts": -1,
    "ping_interval": 30,
    "ping_timeout": 10,
    "close_timeout": 5,
    "connection_timeout": 10
  },
  "translation_config": {
    "baidu_app_id": "",
    "baidu_secret_key": "",
    "enabled": false,
    "use_place_name_fix": true
  },
  "enabled_sources": {
    "wss://ws.fanstudio.tech/all": true
  },
  "magnitude_filter": {
    "enabled": false,
    "warning_min_magnitude": 0.0,
    "report_min_magnitude": 0.0,
    "other_min_magnitude": 0.0
  }
}
```

### 配置项说明

#### GUI配置（gui_config）

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| font_size | int | 40 | 字体大小（10-100） |
| text_speed | float | 4.0 | 滚动速度（0.1-20.0） |
| bg_color | string | "black" | 背景颜色 |
| warning_color | string | "#FF0004" | 预警颜色 |
| info_color | string | "#01FF00" | 信息颜色 |
| opacity | float | 1.0 | 透明度（0.1-1.0） |
| window_width | int | 1000 | 窗口宽度（800-3000） |
| window_height | int | 100 | 窗口高度（100-500） |
| resizable | bool | true | 是否可调整大小 |
| vsync_enabled | bool | true | 垂直同步 |
| target_fps | int | 60 | 目标帧率（1-240） |

#### 消息配置（message_config）

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| max_message_length | int | 0 | 消息最大长度（0=不限制） |
| display_duration | int | 0 | 显示持续时间（秒，0=自动） |
| max_warning_inactivity_time | int | 600 | 预警无活动时长（秒） |
| max_report_inactivity_time | int | 300 | 速报无活动时长（秒） |
| max_other_inactivity_time | int | 300 | 其他消息无活动时长（秒） |
| no_activity_message | string | "系统运行中..." | 无活动提示信息 |
| custom_text | string | "系统运行中..." | 自定义文本 |
| warning_color | string | "#FF0000" | 预警颜色 |
| report_color | string | "#00FFFF" | 速报颜色 |
| default_color | string | "#01FF00" | 默认颜色 |
| weather_warning_color | string | "#FFF500" | 气象预警颜色 |

#### WebSocket配置（ws_config）

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| reconnect_interval | int | 5 | 重连间隔（秒） |
| max_reconnect_attempts | int | -1 | 最大重连次数（-1=无限） |
| ping_interval | int | 30 | 心跳间隔（秒） |
| ping_timeout | int | 10 | 心跳超时（秒） |
| close_timeout | int | 5 | 关闭超时（秒） |
| connection_timeout | int | 10 | 连接超时（秒） |

#### 翻译配置（translation_config）

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| baidu_app_id | string | "" | 百度翻译API ID |
| baidu_secret_key | string | "" | 百度翻译API密钥 |
| enabled | bool | false | 是否启用翻译 |
| use_place_name_fix | bool | true | 是否使用地名修正 |

---

## 数据源说明

### Fan Studio数据源

Fan Studio是一个聚合多个地震数据源的WebSocket服务，支持以下数据源：

#### 地震预警数据源

- **CEA**：中国地震预警网
- **CEA-PR**：中国地震预警网-省级预警
- **Sichuan**：四川地震局地震预警
- **CWA-EEW**：台湾中央气象署地震预警
- **JMA**：日本气象厅地震预警
- **SA**：美国ShakeAlert预警
- **KMA-EEW**：韩国气象厅地震预警

#### 地震速报数据源

- **CENC**：中国地震台网中心自动测定/正式测定
- **Ningxia**：宁夏地震局
- **Guangxi**：广西地震局
- **Shanxi**：山西地震局
- **Beijing**：北京地震局
- **CWA**：台湾中央气象署
- **HKO**：香港天文台
- **USGS**：美国地质调查局
- **EMSC**：欧洲地中海地震中心
- **BCSF**：法国中央地震研究所
- **GFZ**：德国地学研究中心
- **USP**：巴西圣保罗大学
- **KMA**：韩国气象厅
- **FSSN**：FSSN数据源

#### 气象预警数据源

- **WeatherAlarm**：气象预警信号

### 数据源优先级

程序会按照以下优先级处理消息：

1. **地震预警**（最高优先级）
2. **地震速报**
3. **气象预警**

当同时收到多条消息时，预警消息会优先显示。

### 数据源状态

在设置窗口的"数据源"标签页中，可以查看每个数据源的连接状态：

- ✅ **已连接**：数据源连接正常
- ❌ **未连接**：数据源未连接或连接失败
- ⏳ **连接中**：正在尝试连接

---

## 常见问题

### 1. 打包后 exe 无法打开（或闪退）

**现象**：双击 exe 没反应，或任务管理器中看到进程 CPU 很高、内存很小（如 0.1MB）后进程消失。

**可能原因**：安全软件拦截、临时目录无写权限、缺少运行库、OpenGL/显卡驱动不兼容等。单文件 exe 首次运行会解压到临时目录，部分安全软件可能拦截导致无法运行。

**建议步骤**：
1. 查看 **exe 同目录**下是否生成 **启动日志.txt**。若有，请将其中内容提供给维护者，便于排查。
2. 将 exe 或所在文件夹加入杀毒/安全软件白名单后重试；或暂时关闭实时保护再试。
3. 安装 **Visual C++ Redistributable**（2015–2022 x64，微软官网可下）后重试。
4. 若有「调试版」exe（带控制台），从命令行运行该 exe，把控制台中的报错截图或复制发给维护者。
5. 仍不行可尝试右键「以管理员身份运行」一次（仅作测试）。

**日志位置**：若程序曾成功运行过，可查看 `%APPDATA%\subtitl\` 下的 `log.txt` 或 `log_YYYYMMDD.txt` 获取错误信息；若从未成功启动，则依赖 exe 同目录的 **启动日志.txt**。

### 2. 程序无法启动（源码运行或其它）

**问题**：双击 exe 后提示缺少依赖，或从源码运行失败。

**解决方案**：
- 确保系统已安装必要的运行库（Visual C++ Redistributable）
- 若从源码运行，检查是否已安装所有依赖：`pip install -r requirements.txt`
- 查看日志文件：`%APPDATA%\subtitl\log.txt` 或 `log_YYYYMMDD.txt`

### 3. 无法连接到数据源

**问题**：窗口显示"系统运行中，等待最新地震信息..."，但没有收到任何消息。

**解决方案**：
- 检查网络连接是否正常
- 检查防火墙是否阻止了程序访问网络
- 在设置窗口中查看数据源连接状态
- 查看日志文件了解详细错误信息

### 4. 消息显示不完整

**问题**：滚动文字被截断或显示不完整。

**解决方案**：
- 在设置窗口中调整"窗口宽度"，增加显示区域
- 检查"消息最大长度"设置，确保没有限制过短
- 调整字体大小以适应窗口

### 5. 滚动速度不合适

**问题**：文字滚动太快或太慢。

**解决方案**：
- 在设置窗口的"显示设置"标签页中调整"滚动速度"
- 速度值越大，滚动越快（范围：0.1-20.0）

### 6. 窗口位置不合适

**问题**：窗口位置不理想，遮挡了其他内容。

**解决方案**：
- 直接拖拽窗口到合适位置
- 窗口默认置顶显示，确保信息始终可见
- 可以调整窗口透明度，减少对视觉的干扰

### 7. 收到重复消息

**问题**：同一条消息显示多次。

**解决方案**：
- 程序已内置去重机制，会自动过滤重复消息
- 如果仍然出现重复，可能是不同数据源发送的相同消息，这是正常现象

### 8. 日志文件过大

**问题**：日志文件占用大量磁盘空间。

**解决方案**：
- 定期清理 `%APPDATA%\subtitl\` 目录下的旧日志文件（如 `log.txt`、`log_YYYYMMDD.txt`）
- 可以删除较早的日志以释放空间

### 9. 配置丢失

**问题**：重新安装或移动程序后，之前的配置丢失。

**解决方案**：
- 配置文件保存在用户目录：`C:\Users\你的用户名\AppData\Roaming\subtitl\settings.json`
- 可以备份此文件，需要时恢复
- 程序首次运行会自动创建默认配置

---

## 技术架构

### 项目结构

```
滚动字幕/
├── main.py                    # 主程序入口
├── config.py                  # 配置管理模块
├── gui/                       # GUI模块
│   ├── main_window.py         # 主窗口
│   ├── scrolling_text.py      # 滚动文本组件
│   ├── message_manager.py     # 消息管理
│   └── settings_window.py     # 设置窗口
├── adapters/                  # 数据源适配器
│   ├── base_adapter.py        # 适配器基类
│   ├── fanstudio_adapter.py   # Fan Studio适配器
│   └── p2pquake_adapter.py    # P2PQuake适配器
├── data_sources/              # 数据源管理
│   ├── websocket_manager.py   # WebSocket管理器
│   └── http_polling_manager.py # HTTP轮询管理器
└── utils/                     # 工具模块
    ├── logger.py              # 日志工具
    ├── message_processor.py   # 消息处理器
    ├── place_name_fixer.py    # 地名修正工具
    └── translation_service.py  # 翻译服务
```

### 技术栈

- **GUI框架**：PyQt5
- **WebSocket客户端**：websockets
- **HTTP客户端**：requests
- **图像处理**：Pillow
- **日志系统**：Python logging

### 核心模块说明

#### 1. 主程序（main.py）

- 程序入口点
- 初始化GUI应用
- 加载配置
- 创建主窗口

#### 2. 配置管理（config.py）

- 单例模式管理配置
- 支持配置验证
- 自动保存和加载配置
- 支持配置变更回调

#### 3. 主窗口（gui/main_window.py）

- 创建和管理滚动字幕窗口
- 处理用户交互
- 管理数据源连接
- 协调消息显示

#### 4. 消息管理（gui/message_manager.py）

- 消息队列管理
- 消息去重
- 消息优先级处理
- 消息缓冲

#### 5. 数据源适配器（adapters/）

- 统一的数据源接口
- 不同数据源的解析逻辑
- 数据格式转换
- 机构名称映射

#### 6. WebSocket管理（data_sources/websocket_manager.py）

- WebSocket连接管理
- 自动重连机制
- 心跳检测
- 消息接收和分发

### 数据流程

```
数据源 (WebSocket)
    ↓
WebSocket管理器
    ↓
适配器 (解析数据)
    ↓
消息处理器
    ↓
消息管理器 (去重、优先级)
    ↓
滚动文本组件 (显示)
```

---

## 更新日志

### 版本历史

#### v2.1.2（当前版本）

- 创建调试版的打包文件（build_lite_debug.spec），打包后为带控制台的 exe，便于在正式版无法打开时从命令行查看报错。

#### v2.1

- ✅ 迁移到PyQt5框架，解决窗口静止时卡顿问题
- ✅ 支持多数据源聚合显示
- ✅ 完善的消息去重机制
- ✅ 支持震级过滤
- ✅ 支持地名修正
- ✅ 图形化设置界面
- ✅ 完整的日志系统
- ✅ 自动重连机制

#### 主要改进（v2.1）

1. **性能优化**：使用PyQt5替代原有GUI框架，解决卡顿问题
2. **功能增强**：支持更多数据源，消息处理更智能
3. **用户体验**：提供图形化设置界面，配置更便捷
4. **稳定性**：完善的错误处理和自动重连机制

---

## 许可证

本项目仅供学习和研究使用。

---

## 技术支持

如遇到问题或需要帮助，请：

1. 查看日志文件：`%APPDATA%\subtitl\log.txt` 或 `log_YYYYMMDD.txt`；若程序无法启动，查看 exe 同目录的 **启动日志.txt**
2. 检查配置文件是否正确
3. 确认网络连接正常
4. 查看本文档的「常见问题」部分

---

**最后更新**：2026年2月

**版本**：2.1.2
